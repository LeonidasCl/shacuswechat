<!DOCTYPE>
<html>
<head>
	<meta charset="utf-8">
	<title>形象展示</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
	<link rel="stylesheet" href="style/weui-0.4.3.css"/>
	<link rel="stylesheet" href="style/weui-0.4.css"/>
	<script src="scripts/jweixin-1.0.0.js"></script>
	<script src="scripts/zepto.min.js"></script>
	<script src="scripts/swipe.js"></script>
	<link rel="stylesheet" href="http://res.wx.qq.com/open/libs/weui/1.0.0/weui.css"/>
    <script type="text/javascript">
        function GetQueryString(name)
      {
        var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if(r!=null)return  unescape(r[2]); return null;
      }
    </script>
</head>
<body>
	<div class="weui_media_box">
	 	<!-- <div class="weui_grids">
	 			    <a href="javascript:;" class="weui-grid" style="background-image:url(http://img5.imgtn.bdimg.com/it/u=3780274376,4212295351&fm=21&gp=0.jpg);background-size: 98% 98%;background-position:center center;background-repeat: no-repeat;height: 110px"></a>
	 				<a href="javascript:;" class="weui-grid" style="background-image:url(http://img5.imgtn.bdimg.com/it/u=3780274376,4212295351&fm=21&gp=0.jpg);background-size: 98% 98%;background-position:center center;background-repeat: no-repeat;height: 110px"></a>
	 				<a href="javascript:;" class="weui-grid" style="background-image:url(http://img5.imgtn.bdimg.com/it/u=3780274376,4212295351&fm=21&gp=0.jpg);background-size: 98% 98%;background-position:center center;background-repeat: no-repeat;height: 110px"></a>
	 				<a href="javascript:;" class="weui-grid" style="background-image:url(http://img5.imgtn.bdimg.com/it/u=3780274376,4212295351&fm=21&gp=0.jpg);background-size: 98% 98%;background-position:center center;background-repeat: no-repeat;height: 110px"></a>
	 				<a href="javascript:;" class="weui-grid" style="background-image:url(http://img5.imgtn.bdimg.com/it/u=3780274376,4212295351&fm=21&gp=0.jpg);background-size: 98% 98%;background-position:center center;background-repeat: no-repeat;height: 110px"></a>
	 				<a href="javascript:;" class="weui-grid" style="background-image:url(http://img5.imgtn.bdimg.com/it/u=3780274376,4212295351&fm=21&gp=0.jpg);background-size: 98% 98%;background-position:center center;background-repeat: no-repeat;height: 110px"></a>
	 				<a href="javascript:;" class="weui-grid" style="background-image:url(http://img5.imgtn.bdimg.com/it/u=3780274376,4212295351&fm=21&gp=0.jpg);background-size: 98% 98%;background-position:center center;background-repeat: no-repeat;height: 110px"></a>
	 				<a href="javascript:;" class="weui-grid" style="background-image:url(http://img5.imgtn.bdimg.com/it/u=3780274376,4212295351&fm=21&gp=0.jpg);background-size: 98% 98%;background-position:center center;background-repeat: no-repeat;height: 110px"></a>
	 			</div> -->

			<div class="weui-uploader__bd">
                            <ul class="weui-uploader__files" id="uploaderFiles">
                                <!--<li class="weui-uploader__file" style="background-image:url(./images/pic_160.png) ;width:30%;height:110px;"></li>
                                <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png);width:30%;height:110px;"></li>
                                <li class="weui-uploader__file" style="background-image:url(./images/pic_160.png);width:30%;height:110px;"></li>-->
                            </ul>
                            <!-- <div class="weui-uploader__input-box" style="width:30%;height:110px" onclick="uploadImg();" >
                                <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" multiple="">
                            </div> -->
                            <div class="weui-uploader__input-box" style="width:30%;height:110px">
                                <!--<input id="uploaderInput" class="weui-uploader__input js_file" type="file" accept="image/*" multiple />-->
                                <ul>
                                	<li id="uploaderInput" class="weui-uploader__file" onclick="uploadImg();" />
                                </ul>
                            </div>
                        </div>

	</div>
	<!-- <div class="weui_media_text weui-cell" style="margin-top:5dp;">
		<P><span>&nbsp&nbsp</span>这是一大段自我介绍</P>	
	</div> -->

    <div class="weui-cell" id="fcom">
            <div class="weui-cell__bd weui_cell_primary">
                <textarea id="textarea" class="weui-textarea" style="padding:6px" placeholder="分享你的约拍心得" rows="6">在这里写下你的简要介绍</textarea>
            </div>
    </div>
    <div class="weui_opr_area" style="margin-bottom:0px">
        <p class="weui_btn_area">
            <!-- <a href="javascript:;" class="weui_btn weui_btn_default">暂不评价</a> -->
            <a href="javascript:" onclick="server()" class="weui_btn weui_btn_primary">修改签名与图片</a>
        </p>
    </div>
</body>
</html>

<script language="javascript">

    var phone=GetQueryString("vail");
    //var date=GetQueryString("date");
     $.getJSON("http://www.shacus.top/weixin/getsign?appsecret=f1dad656a7269b068834b5007991b46b&type=http://www.shacus.top/static/UserDisplay.html?vali="+phone+"&jsoncallback=?",
      function(json){
        //console.log('done');
        var url=json.url;
        timestamp=json.timestamp;
        nonceStr=json.nonceStr;
        signature=json.signature;
      //if(json.属性名==值){
      // 执行代码
            //}
    wx.config({
        debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        appId: 'wx0c9dd1c77d3e5295', // 必填，公众号的唯一标识
        timestamp: timestamp, // 必填，生成签名的时间戳
        nonceStr: nonceStr, // 必填，生成签名的随机串
        signature: signature,// 必填，签名，见附录1
        jsApiList: ['chooseImage','previewImage','uploadImage','downloadImage'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
        });
    });

	function uploadImg(){

    var maxSize = 10 * 1024 * 1024;
    // 图片最大宽度
    var maxWidth = 100;
    
    var imgs = [];
    var previews =[];
    var images = {
        localIds: [],
        serverIds: []
        };
    var num = $('.weui-uploader__file').length-1;
    if (num==maxCount) {
        alert('最多只能上传5张图片！');
        return;
    }
    wx.chooseImage({
                count: maxCount-num,//最大可选择的图片张数
                sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                success: function (res) {
                    images.localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                    console.log('choosed '+images.localIds);
                    var i = 0, length = images.localIds.length;

                    //var files = event.target.files;
                    if ( length== 0) {
                        alert('请选择图片');
                        return;
                    }
                    
                    for (var j = 0; j<length; j++) {

                        //alert('inserting local '+images.localIds[j]);                    
                        //$preview = $('<li class="weui-uploader__file weui-uploader__file_status" style="background-image:url(./images/pic_160.png)"><img src='+images.localIds[j]+' height="80" width="80"/><div class="weui-uploader__file-content">正在上传</div></li>');

                        $preview = $('<li id='+globalImgId+' class="weui-uploader__file weui-uploader__file_status" style="background-image:url('+images.localIds[j]+');"><div class="weui-uploader__file-content">正在上传</div></li>');
                        globalImgId++;//分配完全局图片id后将id加一
                        $('.weui-uploader__files').append($preview);
                        previews.push($preview);
                        num = $('.weui-uploader__file').length-1;
                        $('.js_counter').text(num + '/' + maxCount);//因为上传按钮用的布局类和上传图片一致，所以要减去1
                        //alert('inserted');
                        console.log('now preview '+previews);
                    }
                    var count=0;
                    function upload() {
                          wx.uploadImage({
                            localId: images.localIds[count],
                            success: function (res) {
                                console.log('goto removing no. '+count);
                                console.log('removing '+ $(previews[count]).html());
                                console.log('removing '+ previews[count][0]);
                                $(previews[count]).removeClass('weui-uploader__file_status').find('.weui-uploader__file-content').remove();
                                console.log('upload success');
                                //alert('upload success');
                                //images.serverIds.push(res.serverId);
                                //document.getElementById("yuepai_contents")[0].value=res.serverId;;
                                //$("#yuepai_contents").val(res.serverId);
                                //res.serverId;
                                globalImgs.push(res.serverId);
                                count++;
                                if (count < length) {
                                    upload();//递归的上传
                                }
                            },
                            fail: function (res){
                                console.log('upload fail');
                              //alert('fail '+JSON.stringify(res));
                              $(previews[count]).find('.weui-uploader__file-content').html('<i class="weui_icon_warn"></i>');
                                count++;//失败了不重试直接传下一张
                                if (count < length) {
                                    upload();//递归的上传
                                }
                            }
                          });
                    }
                    console.log('start upload');
                    //alert('start upload');
                    upload();//递归上传的第一次调用
            } 
        });
}

function deleteImage(){
    //alert('delete!');
    var count = $('.weui-uploader__file').length-1;//把数量展示减一
    $('.js_counter').text(count-1 + '/' + maxCount);
    $("#"+deleteID+"").remove();
    globalImgs[deleteID]='#';//设置对应的id为无效
    alert('now the global is  '+globalImgs);
}

function server(){
    var sign=textarea.value;
    alert(sign);
    $.getJSON('http://www.shacus.top/weixin/'+'&jsoncallback=?',
                    function(json) {
                    //
                });
}

</script>
